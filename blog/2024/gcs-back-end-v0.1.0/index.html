<!DOCTYPE html> <html lang="zh"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> gcs-back-end v0.1.0 开发实录 | Kaiser's Homepage </title> <meta name="author" content="Kaiser Yang"> <meta name="description" content="This homepage is for sharing everything I know. "> <meta name="keywords" content="C/C++, Java, Python"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.4/dist/bootstrap-table.min.css" integrity="sha256-uRX+PiRTR4ysKFRCykT8HLuRCub26LgXJZym3Yeom1c=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://kaiser-yang.github.io/blog/2024/gcs-back-end-v0.1.0/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Kaiser's Homepage </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">Ctrl K <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">gcs-back-end v0.1.0 开发实录</h1> <p class="post-meta"> Created in August 12, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/category/java"> <i class="fa-solid fa-tag fa-sm"></i> Java</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>NOTE: 文章内容按照时间 <code class="language-plaintext highlighter-rouge">pr</code> 创建的时间线进行排列。</p> <p>仓库地址：<a href="https://github.com/CMIPT/gcs-back-end" rel="external nofollow noopener" target="_blank">gcs-back-end</a></p> <h1 id="add-docker-creator-and-format-action">Add docker creator and format action</h1> <p><code class="language-plaintext highlighter-rouge">pr</code>的链接：<a href="https://github.com/CMIPT/gcs-back-end/pull/1" rel="external nofollow noopener" target="_blank">gcs-pull-1</a></p> <h2 id="google-java-style-format">Google Java Style Format</h2> <p>本次<code class="language-plaintext highlighter-rouge">pr</code>添加了<code class="language-plaintext highlighter-rouge">docker</code>的创建和格式化<code class="language-plaintext highlighter-rouge">action</code>。该<code class="language-plaintext highlighter-rouge">action</code>能够在创建合入<code class="language-plaintext highlighter-rouge">master</code>和<code class="language-plaintext highlighter-rouge">develop</code>的 <code class="language-plaintext highlighter-rouge">pr</code>时，自动使用<code class="language-plaintext highlighter-rouge">Google Java Style Format</code>对<code class="language-plaintext highlighter-rouge">Java</code>代码进行格式化，并且自动创建一个新的<code class="language-plaintext highlighter-rouge">commit</code>提交 格式化后的代码。</p> <p>创建这个<code class="language-plaintext highlighter-rouge">git action</code>的主要目的是为了保证整个团队编码风格的一致性。</p> <p>Issues:</p> <ul class="task-list"> <li class="task-list-item"> <input type="checkbox" class="task-list-item-checkbox" disabled>这个<code class="language-plaintext highlighter-rouge">action</code>目前还有一些问题，比如新创建的提交依然会触发一次该<code class="language-plaintext highlighter-rouge">action</code>。</li> </ul> <p>NOTE: <code class="language-plaintext highlighter-rouge">git action</code>的代码中出现了<code class="language-plaintext highlighter-rouge">secrets.PAT</code>，该字段需要在仓库的设置部分自行进行设置，值的内容是一 个<code class="language-plaintext highlighter-rouge">token</code>该<code class="language-plaintext highlighter-rouge">token</code>具有仓库的写权限，这样自动提交的时候才能保证能够成功提交。而<code class="language-plaintext highlighter-rouge">token</code>的创建方法是在 个人的<code class="language-plaintext highlighter-rouge">github</code>账号中。</p> <p>在<code class="language-plaintext highlighter-rouge">github</code>中创建<code class="language-plaintext highlighter-rouge">token</code>：</p> <p><img src="https://raw.githubusercontent.com/Kaiser-Yang/image-hosting-site/main/20240421-20250421/20240801102637.png" alt=""></p> <p>如何在仓库的<code class="language-plaintext highlighter-rouge">secrets</code>中添加<code class="language-plaintext highlighter-rouge">token</code>：</p> <p><img src="https://raw.githubusercontent.com/Kaiser-Yang/image-hosting-site/main/20240421-20250421/20240801102200.png" alt=""></p> <h2 id="docker-creator">Docker Creator</h2> <p>本次<code class="language-plaintext highlighter-rouge">pr</code>中还添加了一个第三方依赖，用于创建<code class="language-plaintext highlighter-rouge">docker</code>镜像。这个镜像能够自动创建一个<code class="language-plaintext highlighter-rouge">docker</code>镜像并安装 一些基础的工具，例如<code class="language-plaintext highlighter-rouge">ssh</code>等。</p> <p>第三方依赖的地址：<a href="https://github.com/CMIPT/docker-script.git" rel="external nofollow noopener" target="_blank">docker-creator</a></p> <h1 id="initialize-the-project">Initialize the project</h1> <p><code class="language-plaintext highlighter-rouge">pr</code>的链接：<a href="https://github.com/CMIPT/gcs-back-end/pull/2" rel="external nofollow noopener" target="_blank">gcs-pull-2</a></p> <p>本次<code class="language-plaintext highlighter-rouge">pr</code>是从<a href="https://start.spring.io/" rel="external nofollow noopener" target="_blank">spring-io</a>上创建了一个<code class="language-plaintext highlighter-rouge">Spring Boot</code>的项目，然后将其解压到了 仓库中。</p> <p>TODO:</p> <ul class="task-list"> <li class="task-list-item"> <input type="checkbox" class="task-list-item-checkbox" disabled>添加<code class="language-plaintext highlighter-rouge">spring</code>的基本使用介绍</li> </ul> <h1 id="build-the-initial-database-script">Build the initial database script</h1> <p><code class="language-plaintext highlighter-rouge">pr</code>的链接：<a href="https://github.com/CMIPT/gcs-back-end/pull/3" rel="external nofollow noopener" target="_blank">gcs-pull-3</a></p> <h1 id="provide-python-scripts-to-process-json-files">Provide Python scripts to process Json files</h1> <p><code class="language-plaintext highlighter-rouge">pr</code>的链接：<a href="https://github.com/CMIPT/gcs-back-end/pull/6" rel="external nofollow noopener" target="_blank">gcs-pull-6</a></p> <p>本次的<code class="language-plaintext highlighter-rouge">pr</code>提供了处理<code class="language-plaintext highlighter-rouge">Json</code>文件的<code class="language-plaintext highlighter-rouge">Python</code>脚本，脚本接受一个参数，表示文件所在目录。默认值为 <code class="language-plaintext highlighter-rouge">../config.json</code>。脚本内置函数将<code class="language-plaintext highlighter-rouge">Json</code>文件的内容值存入对象<code class="language-plaintext highlighter-rouge">a</code>, 并可以通过点操作符<code class="language-plaintext highlighter-rouge">.</code>访问对象属性来 获取对应内容值。</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">loadJsonAsObject</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="c1"># transmit dictronary into object
</span>    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">object_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="nc">SimpleNamespace</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">))</span>


<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Process JSON file.</span><span class="sh">"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">file_path</span><span class="sh">'</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="sh">'</span><span class="s">?</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">../config.json</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Path to the JSON file</span><span class="sh">"</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>
</code></pre></div></div> <p>下面介绍一下上述代码使用的<code class="language-plaintext highlighter-rouge">argparse</code>功能：</p> <ul> <li> <code class="language-plaintext highlighter-rouge">argparse.ArgumentParser</code>：该类用于创建一个参数解析器对象。<code class="language-plaintext highlighter-rouge">description</code>参数可以用于设置命令行工具的简短描述。</li> <li> <code class="language-plaintext highlighter-rouge">parser.add_argument</code>：定义程序可以接受的命令行参数。 <ul> <li> <code class="language-plaintext highlighter-rouge">file_path</code>：这是定义的命令行参数名。它将接受用户输入的文件路径。</li> <li> <code class="language-plaintext highlighter-rouge">nargs='?'</code>：表示该参数是可选的。如果用户没有提供该参数，则使用默认值。</li> <li> <code class="language-plaintext highlighter-rouge">default='../config.json'</code>：如果用户没有提供<code class="language-plaintext highlighter-rouge">file_path</code>参数，则默认使用<code class="language-plaintext highlighter-rouge">../config.json</code>作为文件路径。</li> <li> <code class="language-plaintext highlighter-rouge">help="Path to the JSON file"</code>：提供该参数的帮助信息，当用户使用<code class="language-plaintext highlighter-rouge">--help</code>选项时会显示这些信息。</li> </ul> </li> <li> <code class="language-plaintext highlighter-rouge">args = parser.parse_args()</code>：解析命令行参数，并将结果存储在<code class="language-plaintext highlighter-rouge">args</code>对象中。</li> </ul> <p>函数<code class="language-plaintext highlighter-rouge">loadJsonAsObject()</code>使用<code class="language-plaintext highlighter-rouge">json.loads()</code>时默认将内容解析成字典对象<code class="language-plaintext highlighter-rouge">dict</code>, 使用<code class="language-plaintext highlighter-rouge">SimpleNamespace</code>参数 后，允许像访问对象属性一样访问字典键。</p> <h1 id="add-spring-doc-for-restful-api">Add spring-doc for restful api</h1> <p><code class="language-plaintext highlighter-rouge">pr</code>的链接：<a href="https://github.com/CMIPT/gcs-back-end/pull/7" rel="external nofollow noopener" target="_blank">gcs-pull-7</a></p> <p>本次的<code class="language-plaintext highlighter-rouge">pr</code>主要是添加了<code class="language-plaintext highlighter-rouge">spring-doc</code>的依赖，用于生成<code class="language-plaintext highlighter-rouge">restful api</code>的文档。</p> <p>集成文档的时候开始在尝试使用<code class="language-plaintext highlighter-rouge">spring-fox</code>和<code class="language-plaintext highlighter-rouge">spring-swagger</code>。结果发现和<code class="language-plaintext highlighter-rouge">spring3.x</code>的版本不兼容，然后 搜索资料发现了<code class="language-plaintext highlighter-rouge">spring-doc</code>这个依赖，然后就使用了这个依赖。</p> <p>TODO:</p> <ul class="task-list"> <li class="task-list-item"> <input type="checkbox" class="task-list-item-checkbox" disabled>添加<code class="language-plaintext highlighter-rouge">spring-doc</code>的使用介绍</li> </ul> <h1 id="finish-part-of-the-deploy-script">Finish part of the deploy script</h1> <p><code class="language-plaintext highlighter-rouge">pr</code>的链接：<a href="https://github.com/CMIPT/gcs-back-end/pull/9" rel="external nofollow noopener" target="_blank">gcs-pull-9</a></p> <p>创建这个脚本的目的是希望能够仅仅通过编写一个<code class="language-plaintext highlighter-rouge">json</code>的配置文件，就能够完成整个项目的部署。这个<code class="language-plaintext highlighter-rouge">pr</code>完成 了部分的功能，还有一些功能没有完成。</p> <p>主脚本是一个<code class="language-plaintext highlighter-rouge">bash</code>脚本，在<code class="language-plaintext highlighter-rouge">bash</code>脚本中会自动安装<code class="language-plaintext highlighter-rouge">python</code>等依赖，然后调用<code class="language-plaintext highlighter-rouge">python</code>脚本来完成部署。部署 的主要逻辑是通过读取<code class="language-plaintext highlighter-rouge">json</code>文件，然后根据配置文件完成一系列处理，最后将<code class="language-plaintext highlighter-rouge">jar</code>通过<code class="language-plaintext highlighter-rouge">Sys V init</code>注册成 一个服务。</p> <p><code class="language-plaintext highlighter-rouge">Sys V init</code>创建服务的方式非常简单，只需要在<code class="language-plaintext highlighter-rouge">/etc/init.d/</code>目录下放置一个可执行文件，然后即可通过 <code class="language-plaintext highlighter-rouge">service xxx start</code>来启动服务。在本次的<code class="language-plaintext highlighter-rouge">pr</code>中，直接创建了一个软连接连接到了打包出来的<code class="language-plaintext highlighter-rouge">jar</code>文件，但是 在后续的使用过程中发现这样做存在问题。</p> <p>在本次的提交中，我发现<code class="language-plaintext highlighter-rouge">junit</code>可以使用<code class="language-plaintext highlighter-rouge">spring-boot-test</code>进行替代，于是将之前的<code class="language-plaintext highlighter-rouge">junit</code>的依赖替换成了 <code class="language-plaintext highlighter-rouge">spring-boot-test</code>，并且删除了之前添加的<code class="language-plaintext highlighter-rouge">log4j</code>依赖（后续可以自己设置<code class="language-plaintext highlighter-rouge">spring-boot</code>的日志系统）。</p> <p>下面介绍一下几个脚本有什么作用：</p> <ul> <li> <code class="language-plaintext highlighter-rouge">deploy_ubuntu.sh</code>：这个脚本是主脚本，用于在<code class="language-plaintext highlighter-rouge">ubuntu</code>系统上部署项目，这个脚本再安装一些依赖后便将控制权交给<code class="language-plaintext highlighter-rouge">script/deploy_helper.py</code>。</li> <li> <code class="language-plaintext highlighter-rouge">script/deploy_helper.py</code>：这个脚本读取<code class="language-plaintext highlighter-rouge">json</code>配置文件，然后根据配置文件完成一系列操作，最后将<code class="language-plaintext highlighter-rouge">jar</code>注册成一个服务。</li> <li> <code class="language-plaintext highlighter-rouge">script/get_jar_position.sh</code>：获取<code class="language-plaintext highlighter-rouge">jar</code>的位置，这个脚本会在<code class="language-plaintext highlighter-rouge">deploy_helper.py</code>中被调用，用于获取<code class="language-plaintext highlighter-rouge">mvn package</code>输出位置。</li> </ul> <p>Issues:</p> <ul class="task-list"> <li class="task-list-item"> <input type="checkbox" class="task-list-item-checkbox" disabled checked>这个脚本在某些环境使用的时候出现了问题，详见<a href="https://github.com/CMIPT/gcs-back-end/issues/14" rel="external nofollow noopener" target="_blank">gcs-issues-14</a> </li> <li class="task-list-item"> <input type="checkbox" class="task-list-item-checkbox" disabled checked>错误的添加使用了<code class="language-plaintext highlighter-rouge">spring-boot-test</code>导致添加了<code class="language-plaintext highlighter-rouge">spring-boot-starter-webflux</code>依赖，这个依赖目前应该是不用的。</li> </ul> <h1 id="add-mit-license-and-developers-info">Add MIT license and developers info</h1> <p><code class="language-plaintext highlighter-rouge">pr</code>的链接：<a href="https://github.com/CMIPT/gcs-back-end/pull/13" rel="external nofollow noopener" target="_blank">gcs-pull-13</a></p> <p>本次<code class="language-plaintext highlighter-rouge">pr</code>主要是添加了<code class="language-plaintext highlighter-rouge">MIT</code>的开源协议，以及开发者的信息。</p> <h1 id="substitute-the-sys-v-init-with-systemd">Substitute the Sys V init with systemd</h1> <p><code class="language-plaintext highlighter-rouge">pr</code>的链接：<a href="https://github.com/CMIPT/gcs-back-end/pull/15" rel="external nofollow noopener" target="_blank">gcs-pull-15</a></p> <p>本次<code class="language-plaintext highlighter-rouge">pr</code>主要是将<code class="language-plaintext highlighter-rouge">Sys V init</code>部署服务的方式替换成了<code class="language-plaintext highlighter-rouge">systemd</code>。这样做是因为发现现代的<code class="language-plaintext highlighter-rouge">Linux</code>系统更多地 使用<code class="language-plaintext highlighter-rouge">systemd</code>来管理服务，且<code class="language-plaintext highlighter-rouge">systemd</code>的启动速度等更加优秀，配置更加简单。这次的提交修复了 <a href="https://github.com/CMIPT/gcs-back-end/issues/14" rel="external nofollow noopener" target="_blank">gcs-issues-14</a>。</p> <p>这次的提交中还增加了<code class="language-plaintext highlighter-rouge">config_default.json</code>文件，<code class="language-plaintext highlighter-rouge">config_default.json</code>文件存储默认的配置，当一个配置项 没有被用户重写的时候会使用默认的配置。</p> <p>同时新增了一个<code class="language-plaintext highlighter-rouge">clean_ubuntu.sh</code>脚本用于清空创建的服务等。</p> <p>下面简单介绍一下<code class="language-plaintext highlighter-rouge">systemd</code>的使用方法。</p> <p>要使用<code class="language-plaintext highlighter-rouge">systemd</code>来管理服务，首先需要创建一个<code class="language-plaintext highlighter-rouge">service</code>文件，然后将这个文件放置在<code class="language-plaintext highlighter-rouge">/etc/systemd/system/</code> 目录下。<code class="language-plaintext highlighter-rouge">service</code>文件的内容大致如下：</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Git server center back-end service
<span class="nv">After</span><span class="o">=</span>network.target

<span class="o">[</span>Service]
<span class="nv">PIDFile</span><span class="o">=</span>/var/run/gcs.pid
<span class="nv">User</span><span class="o">=</span>gcs
<span class="nv">WorkingDirectory</span><span class="o">=</span>/opt/gcs
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">RestartSec</span><span class="o">=</span>5
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/java <span class="nt">-jar</span> /opt/gcs/gcs.jar

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div> <p>上面的大部分字段是不用解释的，这里给出一些注意事项：</p> <ul> <li>路径全部使用绝对路径。</li> <li> <code class="language-plaintext highlighter-rouge">systemctl enable gcs</code>表示将服务设置为开机启动，但是如果当前的服务并没有启动，那么这个命令并不会启动服务。</li> <li> <code class="language-plaintext highlighter-rouge">systemctl start gcs</code>表示启动当前的服务，这与<code class="language-plaintext highlighter-rouge">gcs</code>是否被设置为开机启动无关。</li> <li> <code class="language-plaintext highlighter-rouge">systemctl disable gcs</code>和<code class="language-plaintext highlighter-rouge">systemctl stop gcs</code>的关系与上述类似。</li> </ul> <p>NOTE: 简单解释一下<code class="language-plaintext highlighter-rouge">systemctl enable gcs</code>和<code class="language-plaintext highlighter-rouge">systemctl disable gcs</code>的原理。两者只做了一件事情： 根据<code class="language-plaintext highlighter-rouge">[Install]</code>部分的内容创建或者删除软连接，例如上面的例子中，<code class="language-plaintext highlighter-rouge">systemctl enable gcs</code>会在 <code class="language-plaintext highlighter-rouge">/etc/systemd/system/multi-user.target.wants/</code>目录下创建一个<code class="language-plaintext highlighter-rouge">gcs.service</code>的软连接，而 <code class="language-plaintext highlighter-rouge">systemctl disable gcs</code>会删除这个软连接。这个软连接的作用是在<code class="language-plaintext highlighter-rouge">multi-user.target</code>启动的时候启动<code class="language-plaintext highlighter-rouge">gcs</code> 而<code class="language-plaintext highlighter-rouge">Linux</code>系统启动的时候会启动<code class="language-plaintext highlighter-rouge">multi-user.target</code>，所以<code class="language-plaintext highlighter-rouge">gcs</code>也能在开机的时候自动启动。</p> <h1 id="add-command_checker-and-setup_logger-to-scriptdeploy_helperpy">Add command_checker and setup_logger to script/deploy_helper.py</h1> <p><code class="language-plaintext highlighter-rouge">pr</code>的链接：<a href="https://github.com/CMIPT/gcs-back-end/pull/17" rel="external nofollow noopener" target="_blank">gcs-pull-17</a></p> <p>本次<code class="language-plaintext highlighter-rouge">pr</code>修改了<code class="language-plaintext highlighter-rouge">script/deploy_helper.py</code>，增加了日志功能。在执行<code class="language-plaintext highlighter-rouge">deploy_helper.py</code>时，如果命令执行失败， 会输出执行失败的命令的日志信息，包括时间，日志等级，行号，执行失败的命令。</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">logging</span>
<span class="kn">import</span> <span class="n">inspect</span>
</code></pre></div></div> <p>首先，实现这个<code class="language-plaintext highlighter-rouge">pr</code>的功能，需要导入<code class="language-plaintext highlighter-rouge">logging</code>和<code class="language-plaintext highlighter-rouge">inspect</code>模块。<code class="language-plaintext highlighter-rouge">logging</code>模块是<code class="language-plaintext highlighter-rouge">Python</code>内置的日志模块， <code class="language-plaintext highlighter-rouge">inspect</code>模块是<code class="language-plaintext highlighter-rouge">Python</code>内置模块，在这里用于获取命令的行号。</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">setup_logger</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Configure the global logging system.

    :param log_level: Set the logging level, defaulting to INFO.
    </span><span class="sh">"""</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">log_level</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%(asctime)s -%(levelname)s- in %(pathname)s:%(caller_lineno)d: %(message)s</span><span class="sh">'</span><span class="p">,</span> 
                        <span class="n">datefmt</span><span class="o">=</span><span class="sh">'</span><span class="s">%Y-%m-%d %H:%M:%S</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">setup_logger</code>函数用于配置全局的日志系统。<code class="language-plaintext highlighter-rouge">log_level</code>参数用于设置日志级别，默认为<code class="language-plaintext highlighter-rouge">INFO</code>。<code class="language-plaintext highlighter-rouge">logging.basicConfig</code> 定义输出日志的格式，包括时间，日志等级，行号，执行失败的命令。</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">command_checker</span><span class="p">(</span><span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expected_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Check if the command execution status code meets the expected value.

    :param status_code: The actual status code of the command execution.
    :param message: The log message to be recorded.
    :param expected_code: The expected status code, defaulting to 0.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">status_code</span> <span class="o">!=</span> <span class="n">expected_code</span><span class="p">:</span>
        <span class="n">caller_frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">.</span><span class="nf">currentframe</span><span class="p">().</span><span class="n">f_back</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">caller_lineno</span><span class="sh">'</span><span class="p">:</span> <span class="n">caller_frame</span><span class="p">.</span><span class="n">f_lineno</span><span class="p">})</span>
        <span class="nf">exit</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">command_checker</code>用于比较命令执行返回的状态码与期望的状态码是否一致，如果不一致，则说明命令执行失败， 则打印出相应的日志，且返回状态码，如果一致则说明命令执行成功，不做任何操作。</p> <ul> <li> <code class="language-plaintext highlighter-rouge">status_code</code>: 命令执行的实际状态码</li> <li> <code class="language-plaintext highlighter-rouge">message</code>: 要打印的日志信息</li> <li> <code class="language-plaintext highlighter-rouge">expected_code</code>: 期望的状态码，默认为0</li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">message_tmp</span> <span class="o">=</span> <span class="sh">'''</span><span class="se">\
</span><span class="s">The command below failed:
    {0}
Expected status code 0, got status code {1}
</span><span class="sh">'''</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">message_tmp</code>是一个模板字符串，用于格式化输出日志信息，在这里会将执行失败的命令和状态码输出到日志中。</p> <h1 id="remove-unsed-dependency-and-add-doc-for-configuration">Remove unsed dependency and add doc for configuration</h1> <p><code class="language-plaintext highlighter-rouge">pr</code>的链接：<a href="https://github.com/CMIPT/gcs-back-end/pull/22" rel="external nofollow noopener" target="_blank">gcs-pull-22</a></p> <p>本次<code class="language-plaintext highlighter-rouge">pr</code>主要是将<code class="language-plaintext highlighter-rouge">spring-boot-starter-webflux</code>依赖删除，因为这个依赖是多余的。同时添加了一个<code class="language-plaintext highlighter-rouge">README-zh.md</code> 文件，用于存储配置文件的说明。</p> <h1 id="finish-the-script-for-deploying-in-docker">Finish the script for deploying in docker</h1> <p><code class="language-plaintext highlighter-rouge">pr</code>的链接：<a href="https://github.com/CMIPT/gcs-back-end/pull/24" rel="external nofollow noopener" target="_blank">gcs-pull-24</a></p> <p>在本次的提交中，增加了自动在 <code class="language-plaintext highlighter-rouge">docker</code> 中部署的功能。在编写这部分功能的时候，发现 <code class="language-plaintext highlighter-rouge">docker</code> 在默认情况下 是不能够使用 <code class="language-plaintext highlighter-rouge">systemd</code> 的，只有当指明 <code class="language-plaintext highlighter-rouge">--privileged=true</code> 的时候才能够使用 <code class="language-plaintext highlighter-rouge">systemd</code>。这个参数的作用 是让 <code class="language-plaintext highlighter-rouge">docker</code> 在容器中运行的时候拥有直接操作宿主机的权限。如果通过样的方式创建 <code class="language-plaintext highlighter-rouge">docker</code> 失去了 <code class="language-plaintext highlighter-rouge">docker</code> 的部分安全性，因此我将在 <code class="language-plaintext highlighter-rouge">docker</code> 中的部署改用成了 <code class="language-plaintext highlighter-rouge">Sys Init V</code> 的方式，而在物理机上的部署继续保持 <code class="language-plaintext highlighter-rouge">systemd</code> 的方式。</p> <p><code class="language-plaintext highlighter-rouge">Sys Init V</code> 的脚本模板来自于 <a href="https://gist.github.com/naholyr/4275302" rel="external nofollow noopener" target="_blank">_service.md</a> 。我对其中进行了 部分的修改，得到了如下的文件：</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">PIDDIR</span><span class="o">=</span><span class="si">$(</span><span class="nb">dirname</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2">"</span><span class="si">)</span>
<span class="nv">LOGDIR</span><span class="o">=</span><span class="si">$(</span><span class="nb">dirname</span> <span class="s2">"</span><span class="nv">$LOGFILE</span><span class="s2">"</span><span class="si">)</span>
start<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$PIDDIR</span><span class="s2">/</span><span class="nv">$PIDNAME</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> <span class="nt">-0</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">cat</span> <span class="s2">"</span><span class="nv">$PIDDIR</span><span class="s2">/</span><span class="nv">$PIDNAME</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s1">'Service already running'</span> <span class="o">&gt;</span>&amp;2
    <span class="k">return </span>1
  <span class="k">fi
  </span><span class="nb">echo</span> <span class="s1">'Starting service…'</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">local </span><span class="nv">CMD</span><span class="o">=</span><span class="s2">"</span><span class="nv">$SCRIPT</span><span class="s2"> &amp;&gt; </span><span class="se">\"</span><span class="nv">$LOGFILE</span><span class="se">\"</span><span class="s2"> &amp; echo </span><span class="se">\$</span><span class="s2">!"</span>
  su <span class="nt">-c</span> <span class="s2">"mkdir -p ""</span><span class="nv">$PIDDIR</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$RUNAS</span><span class="s2">"</span>
  su <span class="nt">-c</span> <span class="s2">"mkdir -p ""</span><span class="nv">$LOGDIR</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$RUNAS</span><span class="s2">"</span>
  su <span class="nt">-c</span> <span class="s2">"</span><span class="nv">$CMD</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$RUNAS</span><span class="s2">"</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2">"</span>
  <span class="nb">echo</span> <span class="s1">'Service started'</span> <span class="o">&gt;</span>&amp;2
<span class="o">}</span>

stop<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">!</span> <span class="nb">kill</span> <span class="nt">-0</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">cat</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s1">'Service not running'</span> <span class="o">&gt;</span>&amp;2
    <span class="k">return </span>1
  <span class="k">fi
  </span><span class="nb">echo</span> <span class="s1">'Stopping service…'</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">kill</span> <span class="nt">-15</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">cat</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2">"</span>
  <span class="nb">echo</span> <span class="s1">'Service stopped'</span> <span class="o">&gt;</span>&amp;2
<span class="o">}</span>

uninstall<span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"Are you really sure you want to uninstall this service? That cannot be undone. [yes|No] "</span>
  <span class="nb">local </span>SURE
  <span class="nb">read </span>SURE
  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$SURE</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"yes"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>stop
    <span class="nb">rm</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2">"</span>
    <span class="nb">echo</span> <span class="s2">"Notice: log file is not be removed: '</span><span class="nv">$LOGFILE</span><span class="s2">'"</span> <span class="o">&gt;</span>&amp;2
    update-rc.d <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$NAME</span><span class="s2">"</span> remove
    <span class="nb">rm</span> <span class="nt">-fv</span> <span class="s2">"</span><span class="nv">$0</span><span class="s2">"</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="k">case</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="k">in
  </span>start<span class="p">)</span>
    start
    <span class="p">;;</span>
  stop<span class="p">)</span>
    stop
    <span class="p">;;</span>
  uninstall<span class="p">)</span>
    uninstall
    <span class="p">;;</span>
  restart<span class="p">)</span>
    stop
    start
    <span class="p">;;</span>
  <span class="k">*</span><span class="p">)</span>
    <span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> {start|stop|restart|uninstall}"</span>
<span class="k">esac</span>
</code></pre></div></div> <p>上面的脚本需要在最开始添加以下内容才能运行 (等号后面需要添加值)：</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/env bash</span>
<span class="nv">NAME</span><span class="o">=</span>
<span class="nv">SCRIPT</span><span class="o">=</span>
<span class="nv">RUNAS</span><span class="o">=</span>
<span class="nv">PIDFILE</span><span class="o">=</span>
<span class="nv">LOGFILE</span><span class="o">=</span>
</code></pre></div></div> <p>我通过 <code class="language-plaintext highlighter-rouge">Python</code> 脚本读取 <code class="language-plaintext highlighter-rouge">json</code> 配置文件，然后将配置文件的内容写入到 <code class="language-plaintext highlighter-rouge">Sys Init V</code> 的脚本中，最后将 后将这个脚本拷贝到指定目录：</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_sys_v_init_service</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">script/service_tmp.sh</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">service_content</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">command_checker</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'''</span><span class="s">#!/bin/env bash
NAME=</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">serviceName</span><span class="si">}</span><span class="s">
SCRIPT=</span><span class="sh">"</span><span class="si">{</span><span class="nf">parse_iterable_into_str</span><span class="p">([</span><span class="n">config</span><span class="p">.</span><span class="n">serviceStartJavaCommand</span><span class="p">]</span> <span class="o">+</span>
<span class="n">config</span><span class="p">.</span><span class="n">serviceStartJavaArgs</span> <span class="o">+</span> <span class="p">[</span><span class="n">config</span><span class="p">.</span><span class="n">serviceStartJarFile</span><span class="p">])</span><span class="si">}</span><span class="sh">"</span><span class="s">
RUNAS=</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">serviceUser</span><span class="si">}</span><span class="s">
PIDFILE=</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">servicePIDFile</span><span class="si">}</span><span class="s">
LOGFILE=</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">serviceLogFile</span><span class="si">}</span><span class="s">
</span><span class="sh">'''</span>
    <span class="n">service_content</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">service_content</span>
    <span class="nf">log_debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">service_content:</span><span class="se">\n</span><span class="s"> </span><span class="si">{</span><span class="n">service_content</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span>
        <span class="sa">f</span><span class="sh">"</span><span class="s">echo </span><span class="sh">'</span><span class="si">{</span><span class="n">service_content</span><span class="si">}</span><span class="sh">'</span><span class="s"> | </span><span class="si">{</span><span class="n">sudo_cmd</span><span class="si">}</span><span class="s"> tee </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">serviceSysVInitDirectory</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">serviceName</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">command_checker</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Failed to create </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">serviceSysVInitDirectory</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">serviceName</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">sudo_cmd</span><span class="si">}</span><span class="s"> chmod +x </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">serviceSysVInitDirectory</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">serviceName</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">command_checker</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Failed to chmod +x </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">serviceSysVInitDirectory</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">serviceName</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">().</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">serviceSysVInitDirectory</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">serviceName</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="nf">log_debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Service content:</span><span class="se">\n</span><span class="s"> </span><span class="si">{</span><span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">command_checker</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span>
</code></pre></div></div> <p>除了这些更改以外，将依赖的安装交给了 <code class="language-plaintext highlighter-rouge">Python</code> 脚本管理，<code class="language-plaintext highlighter-rouge">bash</code> 脚本仅仅负责安装 <code class="language-plaintext highlighter-rouge">python</code> 依赖。</p> <h1 id="finish-the-deploy-script-for-database">Finish the deploy script for database</h1> <p><code class="language-plaintext highlighter-rouge">pr</code> 链接：<a href="https://github.com/CMIPT/gcs-back-end/pull/25" rel="external nofollow noopener" target="_blank">gcs-pull-25</a></p> <p>本次的 <code class="language-plaintext highlighter-rouge">pr</code> 主要完成了数据库部署部分，根据之前提供的 <code class="language-plaintext highlighter-rouge">SQL</code> 脚本，我们在部署脚本中调用了 <code class="language-plaintext highlighter-rouge">SQL</code> 脚本去 部署数据库。</p> <p>在部署数据库部分，先在数据库中检查是否存在指定的用户，不存在就进行创建，并根据配置文件的密码修改数据 库中用户的密码。之后检查是否存在数据库，不存在就创建数据库。然后给当前用户赋予指定数据库的所有权限。 最后就是通过该用户去调用 <code class="language-plaintext highlighter-rouge">SQL</code> 脚本创建表。</p> <p>除了数据库部分的部署外，还增加了激活不同配置文件的功能。在 <code class="language-plaintext highlighter-rouge">deploy_helper.py</code> 中增加了一个函数：</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">active_profile</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">profile_format</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">spring.profiles.active=</span><span class="si">{</span><span class="nf">parse_iterable_into_str</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">profiles</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">log_debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Profile format: </span><span class="si">{</span><span class="n">profile_format</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">application_config_file_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">application_config_file_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">readlines</span><span class="p">()</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">application_config_file_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">spring.profiles.active</span><span class="sh">'</span><span class="p">):</span>
                        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">profile_format</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">command_checker</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <p>除此之外，我们将 <code class="language-plaintext highlighter-rouge">Spring Boot</code> 的相关配置使用 <code class="language-plaintext highlighter-rouge">yml</code> 格式进行配置，而脚本创建的配置则放置在了 <code class="language-plaintext highlighter-rouge">properties</code> 文件中。这样能保证后续增加的配置一定能生效，因为 <code class="language-plaintext highlighter-rouge">properties</code> 文件的优先级高于 <code class="language-plaintext highlighter-rouge">yml</code> 文件。</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/spring-mvc-intro/">Spring MVC 简介</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/mock-mvc-intro/">Mock Mvc 简介</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/spring-intro/">Spring 简介</a> </li> <div id="giscus_thread" style="max-width: 930px; margin: 0 auto;"> <script>let giscusTheme=determineComputedTheme(),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"Kaiser-Yang/Kaiser-Yang.github.io","data-repo-id":"R_kgDOMlCR5A","data-category":"Announcements","data-category-id":"DIC_kwDOMlCR5M4ChxBw","data-mapping":"pathname","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"1","data-input-position":"top","data-theme":giscusTheme,"data-lang":"zh-CN",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Kaiser Yang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. Last updated: August 19, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script defer src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.4/dist/bootstrap-table.min.js" integrity="sha256-4rppopQE9POKfukn2kEvhJ9Um25Cf6+IDVkARD0xh78=" crossorigin="anonymous"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?601a2d3465e2a52bec38b600518d5f70"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"About",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-blog",title:"Blog",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"nav-projects",title:"Projects",description:"",section:"Navigation",handler:()=>{window.location.href="/projects/"}},{id:"nav-repositories",title:"Repositories",description:"",section:"Navigation",handler:()=>{window.location.href="/repositories/"}},{id:"post-spring-mvc-\u7b80\u4ecb",title:"Spring MVC \u7b80\u4ecb",description:"",section:"Posts",handler:()=>{window.location.href="/blog/2024/spring-mvc-intro/"}},{id:"post-mock-mvc-\u7b80\u4ecb",title:"Mock Mvc \u7b80\u4ecb",description:"",section:"Posts",handler:()=>{window.location.href="/blog/2024/mock-mvc-intro/"}},{id:"post-spring-\u7b80\u4ecb",title:"Spring \u7b80\u4ecb",description:"",section:"Posts",handler:()=>{window.location.href="/blog/2024/spring-intro/"}},{id:"post-gcs-back-end-v0-1-0-\u5f00\u53d1\u5b9e\u5f55",title:"gcs-back-end v0.1.0 \u5f00\u53d1\u5b9e\u5f55",description:"",section:"Posts",handler:()=>{window.location.href="/blog/2024/gcs-back-end-v0.1.0/"}},{id:"news-currently-working-on-gcs-back-end-https-github-com-cmipt-gcs-back-end",title:"Currently working on [gcs-back-end](https://github.com/CMIPT/gcs-back-end).",description:"",section:"News"},{id:"projects-gcs-back-end",title:"gcs-back-end",description:"",section:"Projects",handler:()=>{window.location.href="/projects/gcs-back-end/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%6B%61%69%73%65%72%71%7A%79%75%65@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/Kaiser-Yang","_blank")}},{id:"socials-rss",title:"RSS Feed",section:"Socials",handler:()=>{window.open("/feed.xml","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>